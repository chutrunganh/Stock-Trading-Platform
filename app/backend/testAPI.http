# Install Rest Client extension in VSCode to run this file
# This file contains HTTP requests to test the API endpoints

### CAUTION: DO NOT REMOVE ANY NEWLINE, SPACE OR NUMBER OF # IN THIS FILE, IT WILL BREAK THE REQUESTS

# Initial when server is up, it have already seeded the database with 1 admin account and 1 user account, see
# the file config/createUserTable.js or look at the console log to see the login credentials in plain text.
# you can use these two accounts to test the API endpoints.

### 1. Public endpoints (no authentication required)

### Test for user registration
POST /api/register
Content-Type: application/json

{
  "username": "testuser2",
  "email": "testuser2@example.com",
  "password": "password123"
}

### Test for user account login using seeded user account credentials
# After send this request, you can see the JWT token inside the Cookie header in the response. Copy
# that value (from jwt=... till you meet ;) and paste it into the global variable @user_jwt below
POST /api/login
Content-Type: application/json

{
  "email": "test@example.com",
  "password": "password123"
}

### Replace the JWT token in the Cookie header with the one you received from the login response. This is a global variable used in the requests below that require authentication
# In the cookie header, the token start from jwt=... till you meet ;
@user_jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwidXNlcm5hbWUiOiJUZXN0VXNlciIsImVtYWlsIjoidGVzdEBleGFtcGxlLmNvbSIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzQzMjQ1ODA2LCJleHAiOjE3NDMzMzIyMDZ9.DczNDmIUNGCDGnCgfu9EUVDkRj0Qc1NYqfBavSmyY00




### Test for admin account login using seeded admin account credentials
# After send this request, you can see the JWT token inside the Cookie header in the response. Copy
# that value (from jwt=... till you meet ;) and paste it into the global variable @admin_jwt below. This
# is a global variable used in the requests below that require authentication with admin privileges.
POST /api/login
Content-Type: application/json

{
  "identifier": "admin",
  "password": "admin123"
}


### Replace the JWT token in the Cookie header with the one you received from the login response. This is a global variable used in the requests below that require authentication with admin privileges
@admin_jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MiwidXNlcm5hbWUiOiJBZG1pblVzZXIiLCJlbWFpbCI6ImFkbWluQGV4YW1wbGUuY29tIiwicm9sZSI6ImFkbWluIiwiaWF0IjoxNzQzMjQ2NDc2LCJleHAiOjE3NDMzMzI4NzZ9.e_TGOO4ogWe4ucm0RRYrwqUEj-8pyicB7zTqVpNEW2I

### Testing Google SSO authentication
# Create a new user account using the Google SSO authentication method. This will create a new user in the database with the email address you used to sign in with Google.
# You can use the same email address as the one you used to register with the email and password method above.
# 
# NOTE: Both JWT tokens from email/password login and Google SSO have the same format and work the same way!
# The token contains the same user information (id, username, email, role) regardless of authentication method.
# The only difference is how the user was initially verified (password check vs Google validation).
# The authentication middleware doesn't know or care which login method was used - it only validates the token.
#
# To test this, open: /api/auth/google in your browser(NOT Postman or Rest Client)
# This will redirect you to the Google login page.
# After successful authentication, you'll get a JWT token in the browser response.
# Copy the token and replace YOUR_JWT_TOKEN_HERE with it in the global variable @google_user_jwt below
@google_user_jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MywidXNlcm5hbWUiOiJUcnVuZyBBbmggQ2h1IiwiZW1haWwiOiJjaHV0cnVuZzIxMEBnbWFpbC5jb20iLCJyb2xlIjoidXNlciIsImlhdCI6MTc0MzU5NTY4NCwiZXhwIjoxNzQzNjgyMDg0fQ.GbjJTKYabXr8rBPro_UXNDDtidXxZViRW3OJI7gazmQ

### 2. Protected endpoints (authentication required)
# Test for a protected endpoint that requires authentication. This endpoint returns the user information of the logged in user.
# you can use either $user_jwt, $google_user_jwt or $admin_jwt to test this endpoint.
GET /api/profile
Cookie: jwt={{@{{google_user_jwt}}}} 

### 3. Protected endpoints (authentication required) + admin role required

### Get all users 
GET /api/admin/users
Cookie: jwt={{admin_jwt}}

### Alternative: Test with Authorization header instead of cookie
GET /api/admin/users
Authorization: Bearer {{admin_jwt}}

### Get user by ID
GET /api/admin/user/1
Cookie: jwt={{admin_jwt}}

### Update user by ID
PUT /api/admin/user/1
Content-Type: application/json
Cookie: jwt={{admin_jwt}}

{
  "username": "updatedname",
  "email": "updated@example.com"
}

### Update user password
PUT /api/admin/user/1
Content-Type: application/json
Cookie: jwt={{admin_jwt}}

{
  "password": "newpassword123"
}

### Delete user by ID
DELETE /api/admin/user/1
Cookie: jwt={{admin_jwt}}

### Test for creating a new buy order
POST /api/createOrder
Content-Type: application/json

{
  "userId": 1,
  "stockId": 101,
  "quantity": 20,
  "price": 50,
  "orderType": "Limit Buy"
}

### Test for creating a new sell order
POST /api/createOrder
Content-Type: application/json

{
  "userId": 2,
  "stockId": 101,
  "quantity": 20,
  "price": 5,
  "orderType": "Limit Sell"
}

### Test a market order
POST /api/createOrder
Content-Type: application/json

{
  "userId": 2,
  "stockId": 101,
  "quantity": 30,
  "price": 0,
  "orderType": "Market Buy"
}

### Start trading session
POST /api/startTrading
Content-Type: application/json

### Stop trading session
POST /api/stopTrading
Content-Type: application/json

### Test for creating a new buy order during trading session
POST /api/createOrder
Content-Type: application/json

{
  "userId": 1,
  "stockId": 101,
  "quantity": 20,
  "price": 50,
  "orderType": "Limit Buy"
}

### Test for creating a new buy order outside trading session
POST /api/createOrder
Content-Type: application/json

{
  "userId": 1,
  "stockId": 101,
  "quantity": 20,
  "price": 50,
  "orderType": "Limit Buy"
}
### Test for creating artificial orders
POST /api/createArtiOrder
Content-Type: application/json

{
  "stockId": 101,
  "quantity": 10,
  "price": 50,
  "orderType": "Limit Buy"
}
### Test for canceling an order
DELETE /api/cancelOrder/1744103796519





### Get all stock prices for admin
GET http://localhost:3000/api/admin/stockPrice
Cookie: jwt={{admin_jwt}}

### Get stock prices by stock id for user
### This example will get all the stock prices of the stock with id 1
### the user_jwt may be out-of-date, so be careful
### another way is to login to get the newest jwt
### this feature is for user anyway so only need to care if we are testing
GET http://localhost:3000/api/stockPrice/1
Authorization: Bearer {{user_jwt}}

### Test for Sepay API
GET https://my.sepay.vn/userapi/transactions/details/12462218
Authorization: Bearer N3RTU0OUNCLNHVJBEX9CJMIW4OSM4MQ1KLHFYYVV56UBLH5WXODPPA2FSKGELZT9

### Test for Sepay API
GET https://my.sepay.vn/userapi/transactions/list?reference_number=FT25128764304800
Authorization: Bearer N3RTU0OUNCLNHVJBEX9CJMIW4OSM4MQ1KLHFYYVV56UBLH5WXODPPA2FSKGELZT9

### 4. OTP API tests

### Send OTP to email
// OTP endpoints removed

### 5. IDOR Protection Tests

### Test 1: Try to access another user's portfolio using user1's token
### Should return 403 Forbidden
GET /api/portfolio/c9ba9167-d4ba-48cb-acc1-1e2d568df647
Cookie: jwt="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjkyNjAyMGZhLTIzMWUtNDI3OS04ZDAyLTljN2MxY2VjY2EzZCIsInVzZXJuYW1lIjoidXNlcjEiLCJlbWFpbCI6InVzZXIxQHN0b2NrbWFya2V0LmNvbSIsInJvbGUiOiJ1c2VyIiwidHlwZSI6ImFjY2VzcyIsImxvZ2luX2F0IjoxNzQ4MDEzMjUwMjUyLCJpYXQiOjE3NDgwMTMyNTAsImV4cCI6MTc0ODAxNDE1MH0.aXiLJ9CVwsD4vsqnk3ULgxlMKpXQ3MXR-Rot7DLf2MU"

### Test 2: Try to access another user's transaction history using user1's token
### Should return 403 Forbidden
GET /api/transactions/history/{{portfolioId_of_user2}}
Cookie: jwt={{user_jwt}}

### Test 3: Try to modify another user's portfolio using user1's token
### Should return 403 Forbidden
PUT /api/portfolio/{{portfolioId_of_user2}}
Content-Type: application/json
Cookie: jwt={{user_jwt}}

{
  "cash_balance": 1000000
}

### Test 4: Try to create an order for another user's portfolio
### Should return 403 Forbidden
POST /api/createOrder
Content-Type: application/json
Cookie: jwt={{user_jwt}}

{
  "portfolioId": "{{portfolioId_of_user2}}",
  "stockId": 101,
  "quantity": 20,
  "price": 50,
  "orderType": "Limit Buy"
}

### Test 5: Try to view remembered devices of another user
### Should return 403 Forbidden
GET /api/security/remembered-devices/{{user2_id}}
Cookie: jwt={{user_jwt}}

### Test 6: Positive test - User accessing their own portfolio
### Should return 200 OK
GET /api/portfolio/{{portfolioId_of_user1}}
Cookie: jwt={{user_jwt}}

### Test 7: Admin should be able to access any portfolio
### Should return 200 OK
GET /api/admin/portfolio/{{portfolioId_of_user1}}
Cookie: jwt={{admin_jwt}}

### Test 8: Admin should be able to access any transaction history
### Should return 200 OK
GET /api/admin/transactions/history/{{portfolioId_of_user1}}
Cookie: jwt={{admin_jwt}}

### Variables for IDOR tests (Update these with actual UUIDs after running registration)
@portfolioId_of_user1=00000000-0000-0000-0000-000000000001
@portfolioId_of_user2=00000000-0000-0000-0000-000000000002
@user2_id=00000000-0000-0000-0000-000000000003

